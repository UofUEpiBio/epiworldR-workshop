---
title: "Part 3: Multiple Runs"
---

## Introduction

The purpose of the "run_multiple" function is to run a specified number of simulations using the same model object. That is, this function makes it possible to compare model results across several separate and repeated simulation

## Example: Simulating a SEIRCONN Model 50 Times

#### Setup and Running Model

To use the "run_multiple" function in epiworld, create your epimodel of choice; in this case, the example uses a SEIRCONN model for COVID-19, 100000 people, an initial prevalence of 0.0001 (0.01%), a contact rate of 2, probability of transmission 0.5, a total of 7 incubation days, and probability of recovery $\frac{1}{3}$.

```{r sirconn-setup}
library(epiworldR)
model_seirconn <- ModelSEIRCONN(
  name              = "COVID-19",
  n                 = 10000, 
  prevalence        = 0.0001, 
  contact_rate      = 2,
  prob_transmission = 0.5,
  incubation_days   = 7,
  prob_recovery     = 1/3
  )
```

#### Generating a Saver

Next, generate a saver for the purpose of extracting the "total_hist" and "reproductive" information from the model object. Keep in mind that you can generate a saver for any metric compatible with the "make_saver" function. Now, use the "run_multiple" function with the model object, number of desired days to run the simulation, number of simulations to run, and number of threads for parallel computing.

```{r saver-generation}
# Generating a saver
saver <- make_saver("total_hist", "reproductive")
# Running and printing
run_multiple(model_seirconn, ndays = 50, nsims = 50, saver = saver, nthread = 2)
```

Using the "run_multiple_get_results" function, extract the results from the model object that was simulated 50 times for comparison across simulations.

```{r retrieving-results}
# Retrieving the results
ans <- run_multiple_get_results(model_seirconn)
head(ans$total_hist)
head(ans$reproductive)
```

#### Plotting

To plot the epicurves and reproductive numbers over time using boxplots, extract the results from the model object using "run_multiple_get_results". For this example, the dates are filtered to be less than or equal to 20 to observe the epicurves in the first 20 days. Notice each boxplot in the below table represents the observed values from each of the 50 simulations for each date.

```{r plotting-seirconn-epicurves}
seirconn_50 <- run_multiple_get_results(model_seirconn)$total_hist
seirconn_50 <- seirconn_50[seirconn_50$date <= 20,]
plot(seirconn_50)
```

To view the a plot of the reproductive number over all 50 days for each of the 50 simulations, store the reproductive results to a new object using "run_multiple_get_results", then plot using the "boxplot" function. Notice each source exposure date displays a boxplot representing the distribution of reproductive numbers across all 50 simulations. As expected, the reproductive number on average, decreases over time.

```{r reproductive-number-plot}
seirconn_50_r <- run_multiple_get_results(model_seirconn)$reproductive
plot(seirconn_50_r)
```

## Exercise 1

Consider for this exercise that there is a flu outbreak. Your goal is to 
observe the average reproductive number over 100 simulations. Using a 
run-multiple simulation, what is the average reproductive number 
over the course of the first 20 days? Use a SEIRCONN model with n = 10000,
prevalence = 0.01, contact_rate = 2, prob_transmission = 0.5, 
incubation_days = 2, and prob_recovery = $\frac{1}{7}$.

:::{.callout-tip collapse="true"}
```{mermaid}
flowchart LR
  A[Create epiworldR_model] --> B(Generate saver)
  B --> C(Run epiworldR_model)
  C --> D(Plot average reproductive number)
```
:::

:::{.callout-note collapse="true"}
## Solution 
```{r}
model_seirconn <- ModelSEIRCONN(
  name              = "Flu",
  n                 = 10000, 
  prevalence        = 0.01, 
  contact_rate      = 2,
  prob_transmission = 0.5,
  incubation_days   = 2,
  prob_recovery     = 1/7
)

# Generating a saver
saver <- make_saver("reproductive")

# Running and printing
run_multiple(model_seirconn, ndays = 20, nsims = 100, saver = saver, nthread = 2)

# Plotting
seirconn_100_r <- run_multiple_get_results(model_seirconn)$reproductive
plot(seirconn_100_r)
```
:::

## Exercise 2
Simulate a vaccine intervention for the previous exercise's Flu virus where 50% 
of individuals in the population will receive the vaccine on day 10. How then, 
does the average reproductive number behave over 20 days and 100 simulations? 
Assume the following parameters: susceptibility_reduction = .9, 
transmission_reduction = .5, recovery_enhancer = .5, and death_reduction = .9. 

:::{.callout-tip collapse="true}
```{mermaid}
flowchart LR
  A[Create tool] --> B(Use `globalaction_tool` & `add_global_action`)
  B --> C(Generate saver & run-multiple)
  C --> D(Plot average reproductive number)

```
:::

:::{.callout-note collapse="true"}
## Solution
```{r}
# Creating a tool
epitool <- tool(
  name = "Vaccine",
  susceptibility_reduction = .9,
  transmission_reduction = .5,
  recovery_enhancer = .5, 
  death_reduction = .9
)

# Adding a global action
vaccine_day_10 <- globalaction_tool(epitool, .5, day = 10)
add_global_action(model_seirconn, vaccine_day_10)

# Generating a saver
saver_2 <- make_saver("reproductive")
# Running and printing
run_multiple(model_seirconn, ndays = 20, nsims = 100, saver = saver_2, 
             nthread = 2)

# Plotting
seirconn_100_r2 <- run_multiple_get_results(model_seirconn)$reproductive
plot(seirconn_100_r2)
```
:::

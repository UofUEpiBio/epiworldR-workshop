<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Part 2b: Advanced Modeling - Multiple Diseases, Tools, and Events – epiworldR - Sunbelt 2025 Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CQNCQM1SG1"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-CQNCQM1SG1', { 'anonymize_ip': true});
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="styles.css">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">epiworldR - Sunbelt 2025 Workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./part1.html"> 
<span class="menu-text">Part 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./part2a.html"> 
<span class="menu-text">Part 2a</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./part2b.html" aria-current="page"> 
<span class="menu-text">Part 2b</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./part3.html"> 
<span class="menu-text">Part 3</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./additional-learning.html"> 
<span class="menu-text">Additional Learning</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="https://github.com/UofUEpiBio/epiworldR-workshop"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text">GitHub</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#example-scenario-1-simultaneous-covid-19-and-flu-outbreaks" id="toc-example-scenario-1-simultaneous-covid-19-and-flu-outbreaks" class="nav-link active" data-scroll-target="#example-scenario-1-simultaneous-covid-19-and-flu-outbreaks">Example Scenario 1: Simultaneous COVID-19 and Flu Outbreaks</a>
  <ul class="collapse">
<li><a href="#model-setup" id="toc-model-setup" class="nav-link" data-scroll-target="#model-setup">Model Setup</a></li>
  <li><a href="#add-the-flu-virus" id="toc-add-the-flu-virus" class="nav-link" data-scroll-target="#add-the-flu-virus">Add the Flu Virus</a></li>
  <li><a href="#add-a-tool-vaccine" id="toc-add-a-tool-vaccine" class="nav-link" data-scroll-target="#add-a-tool-vaccine">Add a Tool (Vaccine)</a></li>
  <li><a href="#add-events" id="toc-add-events" class="nav-link" data-scroll-target="#add-events">Add Events</a></li>
  <li><a href="#full-model-summary" id="toc-full-model-summary" class="nav-link" data-scroll-target="#full-model-summary">Full Model Summary</a></li>
  <li><a href="#reproductive-numbers" id="toc-reproductive-numbers" class="nav-link" data-scroll-target="#reproductive-numbers">Reproductive Numbers</a></li>
  </ul>
</li>
  <li>
<a href="#example-scenario-2-comorbidities-using-logit-functions" id="toc-example-scenario-2-comorbidities-using-logit-functions" class="nav-link" data-scroll-target="#example-scenario-2-comorbidities-using-logit-functions">Example Scenario 2: Comorbidities Using Logit Functions</a>
  <ul class="collapse">
<li><a href="#model-setup-1" id="toc-model-setup-1" class="nav-link" data-scroll-target="#model-setup-1">Model Setup</a></li>
  <li><a href="#add-comorbidities" id="toc-add-comorbidities" class="nav-link" data-scroll-target="#add-comorbidities">Add Comorbidities</a></li>
  <li><a href="#set-recovery-rate-based-on-comorbidity" id="toc-set-recovery-rate-based-on-comorbidity" class="nav-link" data-scroll-target="#set-recovery-rate-based-on-comorbidity">Set Recovery Rate Based on Comorbidity</a></li>
  <li><a href="#run-the-model" id="toc-run-the-model" class="nav-link" data-scroll-target="#run-the-model">Run the Model</a></li>
  </ul>
</li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise">Exercise</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">Part 2b: Advanced Modeling - Multiple Diseases, Tools, and Events</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>As mentioned in Part 1, <code>epiworldR</code> models can have multiple viruses, tools, and events. In this part of the workshop, we’ll walk through an example of an advanced model with multiple interacting pieces. We’ll then look at an example of modeling comorbidities.</p>
<section id="example-scenario-1-simultaneous-covid-19-and-flu-outbreaks" class="level2"><h2 class="anchored" data-anchor-id="example-scenario-1-simultaneous-covid-19-and-flu-outbreaks">Example Scenario 1: Simultaneous COVID-19 and Flu Outbreaks</h2>
<p>The example implements the following scenario:</p>
<ul>
<li>
<strong>Diseases:</strong> COVID-19 and Flu</li>
<li>
<strong>Population size:</strong> 50,000 agents</li>
<li>
<strong>Contact Rate:</strong> 4</li>
<li>
<strong>Recovery Rate:</strong> <span class="math inline">\(\frac{1}{4}\)</span> (same for both diseases)</li>
<li>
<em>COVID-19 Parameters</em>
<ul>
<li>
<strong>Initial Prevalence:</strong> 0.001</li>
<li>
<strong>Transmission Rate:</strong> 0.5</li>
</ul>
</li>
<li>
<em>Flu Parameters</em>
<ul>
<li>
<strong>Initial Prevalence:</strong> 0.001</li>
<li>
<strong>Transmission Rate:</strong> 0.35</li>
</ul>
</li>
</ul>
<p>We’ll go through the process step-by-step. After each step, we’ll run the model for 50 days and plot it to illustrate how each added component changes the base model.</p>
<section id="model-setup" class="level3"><h3 class="anchored" data-anchor-id="model-setup">Model Setup</h3>
<p>We start with a <code>ModelSIRCONN</code> model for COVID-19. We’ll add the flu virus and our tools and events to this base model.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(epiworldR)</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a>model_sirconn <span class="ot">&lt;-</span> <span class="fu">ModelSIRCONN</span>(</span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="at">name              =</span> <span class="st">"COVID-19"</span>,</span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="at">n                 =</span> <span class="dv">50000</span>, </span>
<span id="cb1-6"><a href="#cb1-6"></a>  <span class="at">contact_rate      =</span> <span class="dv">4</span>,</span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="at">recovery_rate     =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>,</span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="at">prevalence        =</span> <span class="fl">0.001</span>,</span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="at">transmission_rate =</span> <span class="fl">0.5</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">verbose_off</span>(model_sirconn)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">run</span>(model_sirconn, <span class="at">ndays =</span> <span class="dv">50</span>, <span class="at">seed =</span> <span class="dv">1912</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="fu">plot</span>(model_sirconn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="part2b_files/figure-html/run-base-model-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="add-the-flu-virus" class="level3"><h3 class="anchored" data-anchor-id="add-the-flu-virus">Add the Flu Virus</h3>
<p>Create the second virus using the <code>virus()</code> function. The parameter <code>prob_infecting</code> is the transmission rate. The parameter <code>as_proportion</code> tells the function to interpret the prevalence as a proportion of the population, rather than a fixed value.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>flu_virus <span class="ot">&lt;-</span> <span class="fu">virus</span>(<span class="at">name =</span> <span class="st">"Flu"</span>, <span class="at">prob_infecting =</span> .<span class="dv">35</span>, <span class="at">prevalence =</span> <span class="fl">0.001</span>, <span class="at">as_proportion =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Add the virus to the model with the <code>add_virus()</code> function.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">add_virus</span>(model_sirconn, flu_virus)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">run</span>(model_sirconn, <span class="at">ndays =</span> <span class="dv">50</span>, <span class="at">seed =</span> <span class="dv">1912</span>)</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">plot</span>(model_sirconn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="part2b_files/figure-html/run-model-flu-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="add-a-tool-vaccine" class="level3"><h3 class="anchored" data-anchor-id="add-a-tool-vaccine">Add a Tool (Vaccine)</h3>
<p>In <code>epiworldR</code>, agents use tools to fight diseases. Create the vaccine tool using the <code>tool()</code> function, with parameters that indicate how the tool modifies the disease parameters. We set our vaccine to reduce the susceptibility of agents by 90%, the transmission rate of infected agents by 50%, and the death rate by 90%. The vaccine further enhances the recovery rate by 50%.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>vaccine_tool <span class="ot">&lt;-</span> <span class="fu">tool</span>(</span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="at">name =</span> <span class="st">"Vaccine"</span>,</span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="at">susceptibility_reduction =</span> .<span class="dv">9</span>,</span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="at">transmission_reduction =</span> .<span class="dv">5</span>,</span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="at">recovery_enhancer =</span> .<span class="dv">5</span>, </span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="at">death_reduction =</span> .<span class="dv">9</span>,</span>
<span id="cb6-7"><a href="#cb6-7"></a>  <span class="at">prevalence =</span> <span class="fl">0.5</span>,</span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="at">as_proportion =</span> <span class="cn">TRUE</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Use the <code>set_distribution_tool()</code> function to define the proportion of the population to receive the tool (set here to 50%).</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">set_distribution_tool</span>(</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="at">tool =</span> vaccine_tool,</span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="at">distfun =</span> <span class="fu">distribute_tool_randomly</span>(<span class="fl">0.5</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-4"><a href="#cb7-4"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Add the vaccine to the model using the <code>add_tool()</code> function.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">add_tool</span>(model_sirconn, vaccine_tool)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">run</span>(model_sirconn, <span class="at">ndays =</span> <span class="dv">50</span>, <span class="at">seed =</span> <span class="dv">1912</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">plot</span>(model_sirconn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="part2b_files/figure-html/run-model-vaccine-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note how the vaccine severely limits the number of infected agents.</p>
</section><section id="add-events" class="level3"><h3 class="anchored" data-anchor-id="add-events">Add Events</h3>
<p>In <code>epiworldR</code>, all models automatically have a global event that runs each day to update the agents. For this example, we’ll add two additional events that represent public health interventions that start partway through the simulation as the dual-disease outbreak begins to gain traction:</p>
<ul>
<li>Beginning on Day 10, a policy of social isolation is adopted which reduces the contact rate to 2</li>
<li>Beginning on Day 20, a TV advertisement is run increasing awareness of the outbreak, reducing the contact rate further to 1.5</li>
</ul>
<p>Create these events using the <code>globalevent_set_params()</code> function, specifying the day to run the event.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>isolation_day_10 <span class="ot">&lt;-</span> <span class="fu">globalevent_set_params</span>(<span class="st">"Contact rate"</span>, <span class="dv">2</span>, <span class="at">day =</span> <span class="dv">10</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a>advertisement_day_20 <span class="ot">&lt;-</span> <span class="fu">globalevent_set_params</span>(<span class="st">"Contact rate"</span>, <span class="fl">1.5</span>, <span class="at">day =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Add the events to the model with the <code>add_globalevent()</code> function.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">add_globalevent</span>(model_sirconn, isolation_day_10)</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">add_globalevent</span>(model_sirconn, advertisement_day_20)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">run</span>(model_sirconn, <span class="at">ndays =</span> <span class="dv">50</span>, <span class="at">seed =</span> <span class="dv">1912</span>)</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="fu">plot</span>(model_sirconn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="part2b_files/figure-html/run-full-model-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note the sharp change to the infected curve corresponding to adoptiong of the social isolation policy.</p>
</section><section id="full-model-summary" class="level3"><h3 class="anchored" data-anchor-id="full-model-summary">Full Model Summary</h3>
<p>With our advanced model complete, we can view the summary, noting the events, viruses, and tools we added to the model.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">summary</span>(model_sirconn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>________________________________________________________________________________
________________________________________________________________________________
SIMULATION STUDY

Name of the model   : Susceptible-Infected-Removed (SIR) (connected)
Population size     : 50000
Agents' data        : (none)
Number of entities  : 0
Days (duration)     : 50 (of 50)
Number of viruses   : 2
Last run elapsed t  : 102.00ms
Total elapsed t     : 352.00ms (4 runs)
Last run speed      : 24.31 million agents x day / second
Average run speed   : 28.39 million agents x day / second
Rewiring            : off

Global events:
 - Update infected individuals (runs daily)
 - Set Contact rate to 2 (day 10)
 - Set Contact rate to 1.5 (day 20)

Virus(es):
 - COVID-19
 - Flu

Tool(s):
 - Vaccine

Model parameters:
 - Contact rate      : 1.5000
 - Recovery rate     : 0.2500
 - Transmission rate : 0.5000

Distribution of the population at time 50:
  - (0) Susceptible : 49900 -&gt; 23297
  - (1) Infected    :   100 -&gt; 9
  - (2) Recovered   :     0 -&gt; 26694

Transition Probabilities:
 - Susceptible  0.98  0.02  0.00
 - Infected     0.00  0.72  0.28
 - Recovered    0.00  0.00  1.00</code></pre>
</div>
</div>
</section><section id="reproductive-numbers" class="level3"><h3 class="anchored" data-anchor-id="reproductive-numbers">Reproductive Numbers</h3>
<p>The model computes two reproductive numbers, one for each virus.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>repnum2 <span class="ot">&lt;-</span> <span class="fu">get_reproductive_number</span>(model_sirconn)</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="fu">plot</span>(repnum2, <span class="at">type=</span><span class="st">"b"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="part2b_files/figure-html/reproductive-numbers-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="example-scenario-2-comorbidities-using-logit-functions" class="level2"><h2 class="anchored" data-anchor-id="example-scenario-2-comorbidities-using-logit-functions">Example Scenario 2: Comorbidities Using Logit Functions</h2>
<p>Often, we want to model the effects of comorbidities on a disease. In this example, we’ll examine the effects of obesity on the probability of recovery from the flu.</p>
<section id="model-setup-1" class="level3"><h3 class="anchored" data-anchor-id="model-setup-1">Model Setup</h3>
<p>Create two identical models using the <code>ModelSEIRCONN()</code> function. One will have comorbidities, the other will not.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># With comorbidities</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>model_comorbid <span class="ot">&lt;-</span> <span class="fu">ModelSEIRCONN</span>(</span>
<span id="cb16-3"><a href="#cb16-3"></a>  <span class="at">name              =</span> <span class="st">"Flu"</span>,</span>
<span id="cb16-4"><a href="#cb16-4"></a>  <span class="at">n                 =</span> <span class="dv">10000</span>, </span>
<span id="cb16-5"><a href="#cb16-5"></a>  <span class="at">prevalence        =</span> <span class="fl">0.001</span>, </span>
<span id="cb16-6"><a href="#cb16-6"></a>  <span class="at">contact_rate      =</span> <span class="fl">2.1</span>,</span>
<span id="cb16-7"><a href="#cb16-7"></a>  <span class="at">transmission_rate =</span> <span class="fl">0.5</span>,</span>
<span id="cb16-8"><a href="#cb16-8"></a>  <span class="at">incubation_days   =</span> <span class="dv">7</span>,</span>
<span id="cb16-9"><a href="#cb16-9"></a>  <span class="at">recovery_rate     =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span></span>
<span id="cb16-10"><a href="#cb16-10"></a>  )</span>
<span id="cb16-11"><a href="#cb16-11"></a></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="co"># Without comorbidities</span></span>
<span id="cb16-13"><a href="#cb16-13"></a>model_no_comorbid <span class="ot">&lt;-</span> <span class="fu">ModelSEIRCONN</span>(</span>
<span id="cb16-14"><a href="#cb16-14"></a>  <span class="at">name              =</span> <span class="st">"Flu"</span>,</span>
<span id="cb16-15"><a href="#cb16-15"></a>  <span class="at">n                 =</span> <span class="dv">10000</span>, </span>
<span id="cb16-16"><a href="#cb16-16"></a>  <span class="at">prevalence        =</span> <span class="fl">0.001</span>, </span>
<span id="cb16-17"><a href="#cb16-17"></a>  <span class="at">contact_rate      =</span> <span class="fl">2.1</span>,</span>
<span id="cb16-18"><a href="#cb16-18"></a>  <span class="at">transmission_rate =</span> <span class="fl">0.5</span>,</span>
<span id="cb16-19"><a href="#cb16-19"></a>  <span class="at">incubation_days   =</span> <span class="dv">7</span>,</span>
<span id="cb16-20"><a href="#cb16-20"></a>  <span class="at">recovery_rate     =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span></span>
<span id="cb16-21"><a href="#cb16-21"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="add-comorbidities" class="level3"><h3 class="anchored" data-anchor-id="add-comorbidities">Add Comorbidities</h3>
<p>The file <code>part2b_comorb.rds</code> contains obesity data for the agents. This is formatted as a matrix with two columns: <code>baseline</code> and <code>obesity</code>. We’ll read this in and assign it to the agents of the comorbidity model using the <code>set_agents_data()</code> function.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>obesity_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"part2b_comorb.rds"</span>)</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="fu">set_agents_data</span>(model_comorbid, obesity_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now that population includes some agents with the obesity condition.</p>
</section><section id="set-recovery-rate-based-on-comorbidity" class="level3"><h3 class="anchored" data-anchor-id="set-recovery-rate-based-on-comorbidity">Set Recovery Rate Based on Comorbidity</h3>
<p>Use the <code>virus_fun_logit()</code> function to create a function for the probability of recovery. The function takes the following parameters:</p>
<ul>
<li>
<code>vars</code>: the variables to use in the model</li>
<li>
<code>coefs</code>: the coefficients for each variable</li>
<li>
<code>model</code>: the model object</li>
</ul>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># Logit function </span></span>
<span id="cb18-2"><a href="#cb18-2"></a>lfun <span class="ot">&lt;-</span> <span class="fu">virus_fun_logit</span>(</span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="at">vars  =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="at">coefs =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.0986</span>, <span class="sc">-</span><span class="fl">0.8472</span>), </span>
<span id="cb18-5"><a href="#cb18-5"></a>  model_comorbid</span>
<span id="cb18-6"><a href="#cb18-6"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>To build the logit function, we used the following: (a) Under the logit model, the coefficient needed for the baseline probability of 0.25 is computed using <code>qlogis(0.25)</code>. With that, we can compute the associated coefficient to obese individuals with <code>plogis(qlogis(.25) + x) = .125</code> -&gt; <code>qlogis(.25) + x = plogis(.125)</code> -&gt; <code>x = qlogis(.125) - qlogis(.25)</code></p>
</div>
</div>
<p>Use the <code>set_prob_recovery_fun()</code> function to set the probability of recovery function for the virus to the logit function.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">set_prob_recovery_fun</span>(</span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="at">virus =</span> <span class="fu">get_virus</span>(model_comorbid, <span class="dv">0</span>), </span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="at">model =</span> model_comorbid,</span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="at">vfun  =</span> lfun</span>
<span id="cb19-5"><a href="#cb19-5"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="run-the-model" class="level3"><h3 class="anchored" data-anchor-id="run-the-model">Run the Model</h3>
<p>Run both models for the 50 days with the same random seed and compare the results.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">verbose_off</span>(model_comorbid)</span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="fu">verbose_off</span>(model_no_comorbid)</span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="fu">run</span>(model_comorbid, <span class="at">ndays =</span> <span class="dv">50</span>, <span class="at">seed =</span> <span class="dv">1231</span>)</span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="fu">run</span>(model_no_comorbid, <span class="at">ndays =</span> <span class="dv">50</span>, <span class="at">seed =</span> <span class="dv">1231</span>)</span>
<span id="cb20-5"><a href="#cb20-5"></a></span>
<span id="cb20-6"><a href="#cb20-6"></a>op <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">cex =</span> .<span class="dv">7</span>)</span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="fu">plot_incidence</span>(model_no_comorbid, <span class="at">main =</span> <span class="st">"Without Comorbidities"</span>)</span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="fu">plot_incidence</span>(model_comorbid, <span class="at">main =</span> <span class="st">"With Comorbidities"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="part2b_files/figure-html/run-comorbid-models-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">par</span>(op)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Notice how the comorbidity of obesity results in many more infected agents than the when the comorbidity isn’t present. Also, note how the <code>plot_incidence()</code> function output differs from that of the <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> function.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you want to drill further into this data, you can get the agents’ final states using the function <code>get_agents_states()</code>.</p>
</div>
</div>
</section></section><section id="exercise" class="level2"><h2 class="anchored" data-anchor-id="exercise">Exercise</h2>
<p>Using the <code>ModelSIRCONN()</code> function, create a 75-day simulation of the flu and the Coronavirus Delta variant with a masking tool. Initialize the model with the flu and add the Delta variant and tool to the flu model.</p>
<p>Assume the following:</p>
<ul>
<li>
<strong>Population size:</strong> 10,000 agents</li>
<li>
<strong>Contact Rate:</strong> 2.1</li>
<li>
<strong>Recovery Rate:</strong> <span class="math inline">\(\frac{1}{4}\)</span> (same for both diseases)</li>
<li>
<em>Flu Parameters</em>
<ul>
<li>
<strong>Initial Prevalence:</strong> 0.001</li>
<li>
<strong>Transmission Rate:</strong> 0.5</li>
</ul>
</li>
<li>
<em>Delta variant Parameters</em>
<ul>
<li>
<strong>Initial Prevalence:</strong> 0.001</li>
<li>
<strong>Transmission Rate:</strong> 0.3</li>
</ul>
</li>
<li>
<em>Masking Tool Parameters:</em>
<ul>
<li>
<strong>Transmission_reduction:</strong> 0.3</li>
<li>
<strong>Prevalence:</strong> 0.6</li>
</ul>
</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Masking only influences the transmission of a disease, thus transmission reduction = 0.3, and all other parameters of this tool will be 0.0.</p>
</div>
</div>
</div>
<p>Run the model with <code>seed = 1912</code> and plot the model parameters and reproductive numbers over time.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># Your solution here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>After how many days does the number of infections peak in this simulation? How many infections occur at the peak?</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># Your solution here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>